- name: Load Raspberry Pi Camera kernel module
  # TODO: load module automatically at boot
  modprobe:
    name: bcm2835-v4l2
    state: present
- name: Install FFMPEG container
  docker_container:
    name: ffmpeg
    image: chudsaviet/ffmpeg-omx-rpi-docker:4.1
    pull: yes
    restart_policy: always
    network_mode: host
    devices:
      - /dev/video0:/dev/video0:rw
      - /dev/vchiq:/dev/vchiq:rw
    volumes:
      - /opt/vc/lib:/opt/vc/lib:ro
      - /tmp/rpi_cam:/tmp/rpi_cam:rw
    env:
      TZ: "{{ common.timezone }}"
      LD_LIBRARY_PATH: "/opt/vc/lib"
    command: "ffmpeg -y -f v4l2 -video_size 1280x720 -framerate 24 -i /dev/video0 -vcodec h264_omx -profile:v high -zerocopy 1 -keyint_min 0 -b:v 1024k -flags +cgop -g 24 -f hls -hls_time 1 -hls_flags delete_segments -hls_allow_cache 1 -hls_segment_type fmp4 -hls_list_size 16 -hls_delete_threshold 16 /tmp/rpi_cam/rpi_cam.m3u8"