server {
  include ssl.conf;
  include proxy.conf;

  listen        443 ssl http2;
  server_name   {{ secrets.shelter.server }};

  auth_basic           "Homeunix Shelter";
  auth_basic_user_file /etc/nginx_sec/htpasswd;

  ssl_certificate           /etc/letsencrypt/live/{{ secrets.shelter.server }}/fullchain.pem;
  ssl_certificate_key       /etc/letsencrypt/live/{{ secrets.shelter.server }}/privkey.pem;
  ssl_trusted_certificate   /etc/letsencrypt/live/{{ secrets.shelter.server }}/chain.pem;

  # Docker default DNS server
  resolver 127.0.0.11 ipv6=off;

  # include home_assistant.conf;

  location /{{ home_assistant.web_subdir }} {
      rewrite /{{ home_assistant.web_subdir }}/(.*) /$1 break;
      proxy_pass http://{{ home_assistant.container_name }}:{{ home_assistant.ui_port }};
      proxy_set_header Host $host;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
  }

  location /{{ home_assistant.web_subdir }}/api/websocket {
      rewrite /{{ home_assistant.web_subdir }}/(.*) /$1 break;
      proxy_pass http://{{ home_assistant.container_name }}:{{ home_assistant.ui_port }}/api/websocket;
      proxy_set_header Host $host;
      
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
  }
}